name: Update TMDB Data Daily

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and Transform TMDB Data
        run: |
          python - <<EOF
          import requests
          import json
          import os

          API_KEY = "6358fd374e1372bd48effd9e21521917"
          BASE_URL = "https://api.themoviedb.org/3"
          SAVE_PATH = "public/data"
          os.makedirs(SAVE_PATH, exist_ok=True)

          def fetch_genres():
              """获取类型映射"""
              movie_genres = requests.get(
                  f"{BASE_URL}/genre/movie/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              tv_genres = requests.get(
                  f"{BASE_URL}/genre/tv/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              return {g["id"]: g["name"] for g in movie_genres + tv_genres}

          def get_genre_title(genre_ids, genre_map):
              """获取类型标题（前3个）"""
              if not genre_ids:
                  return ""
              return "•".join([genre_map.get(gid, "") for gid in genre_ids[:3] if gid in genre_map])

          # 获取类型映射
          genre_map = fetch_genres()

          # 获取热门电视剧
          tv_response = requests.get(
              f"{BASE_URL}/trending/tv/day",
              params={"api_key": API_KEY, "language": "zh-CN", "page": 1}
          ).json()

          # 获取热门电影
          movie_response = requests.get(
              f"{BASE_URL}/trending/movie/day",
              params={"api_key": API_KEY, "language": "zh-CN", "page": 1}
          ).json()

          # 转换为代码期望的格式
          today_tv = []
          for item in tv_response.get("results", [])[:20]:
              # 只保留有海报和类型的项目
              if not item.get("poster_path") or not item.get("genre_ids"):
                  continue
                  
              today_tv.append({
                  "id": item.get("id"),
                  "type": "tv",
                  "title": item.get("name", ""),
                  "genreTitle": get_genre_title(item.get("genre_ids", []), genre_map),
                  "rating": item.get("vote_average", 0),
                  "overview": item.get("overview", ""),
                  "release_date": item.get("first_air_date", ""),
                  "poster_url": item.get("poster_path", ""),
                  "title_backdrop": item.get("backdrop_path", ""),
                  "genre_ids": item.get("genre_ids", [])
              })

          today_movies = []
          for item in movie_response.get("results", [])[:20]:
              # 只保留有海报和类型的项目
              if not item.get("poster_path") or not item.get("genre_ids"):
                  continue
                  
              today_movies.append({
                  "id": item.get("id"),
                  "type": "movie",
                  "title": item.get("title", ""),
                  "genreTitle": get_genre_title(item.get("genre_ids", []), genre_map),
                  "rating": item.get("vote_average", 0),
                  "overview": item.get("overview", ""),
                  "release_date": item.get("release_date", ""),
                  "poster_url": item.get("poster_path", ""),
                  "title_backdrop": item.get("backdrop_path", ""),
                  "genre_ids": item.get("genre_ids", [])
              })

          # 保存为代码期望的格式
          output_data = {
              "today_tv": today_tv,
              "today_movies": today_movies
          }

          with open(f"{SAVE_PATH}/TMDB_Trending.json", 'w', encoding='utf-8') as f:
              json.dump(output_data, f, ensure_ascii=False, indent=2)
          
          print(f"Successfully updated TMDB_Trending.json")
          print(f"TV shows: {len(today_tv)}, Movies: {len(today_movies)}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add public/data/*.json
          git commit -m "Update TMDB trending data" || exit 0
          git push
