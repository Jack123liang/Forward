name: Update TMDB Data Daily

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and Transform TMDB Data
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}  # ğŸ”‘ ä» GitHub Secrets è¯»å–
        run: |
          python - <<EOF
          import requests
          import json
          import os
          from datetime import datetime, timedelta

          # ğŸ”‘ ä»ç¯å¢ƒå˜é‡è·å– API Key
          API_KEY = os.environ.get("TMDB_API_KEY")
          
          if not API_KEY:
              print("ERROR: TMDB_API_KEY not found in environment variables!")
              exit(1)
          
          BASE_URL = "https://api.themoviedb.org/3"
          SAVE_PATH = "public/data"
          os.makedirs(SAVE_PATH, exist_ok=True)

          def fetch_genres():
              """è·å–ç±»å‹æ˜ å°„"""
              movie_genres = requests.get(
                  f"{BASE_URL}/genre/movie/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              tv_genres = requests.get(
                  f"{BASE_URL}/genre/tv/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              return {g["id"]: g["name"] for g in movie_genres + tv_genres}

          def get_genre_title(genre_ids, genre_map):
              """è·å–ç±»å‹æ ‡é¢˜ï¼ˆå‰3ä¸ªï¼‰"""
              if not genre_ids:
                  return ""
              return "â€¢".join([genre_map.get(gid, "") for gid in genre_ids[:3] if gid in genre_map])

          def is_recent(date_str, years=2):
              """åˆ¤æ–­æ˜¯å¦ä¸ºè¿‘æœŸå†…å®¹ï¼ˆé»˜è®¤2å¹´å†…ï¼‰"""
              if not date_str:
                  return False
              try:
                  release_date = datetime.strptime(date_str, "%Y-%m-%d")
                  cutoff_date = datetime.now() - timedelta(days=365 * years)
                  return release_date >= cutoff_date
              except:
                  return False

          # è·å–ç±»å‹æ˜ å°„
          genre_map = fetch_genres()

          # è·å–çƒ­é—¨ç”µè§†å‰§ï¼ˆå¤šé¡µä»¥ç¡®ä¿æœ‰è¶³å¤Ÿæ–°å†…å®¹ï¼‰
          tv_items = []
          for page in range(1, 4):  # è·å–å‰3é¡µ
              tv_response = requests.get(
                  f"{BASE_URL}/trending/tv/day",
                  params={"api_key": API_KEY, "language": "zh-CN", "page": page}
              ).json()
              
              for item in tv_response.get("results", []):
                  # è¿‡æ»¤æ¡ä»¶ï¼šå¿…é¡»æœ‰æµ·æŠ¥ã€ç±»å‹ï¼Œä¸”æ˜¯è¿‘2å¹´å†…å®¹
                  if (item.get("poster_path") and 
                      item.get("genre_ids") and 
                      is_recent(item.get("first_air_date", ""), years=2)):
                      
                      tv_items.append({
                          "id": item.get("id"),
                          "type": "tv",
                          "title": item.get("name", ""),
                          "genreTitle": get_genre_title(item.get("genre_ids", []), genre_map),
                          "rating": item.get("vote_average", 0),
                          "overview": item.get("overview", ""),
                          "release_date": item.get("first_air_date", ""),
                          "poster_url": item.get("poster_path", ""),
                          "title_backdrop": item.get("backdrop_path", ""),
                          "genre_ids": item.get("genre_ids", []),
                          "popularity": item.get("popularity", 0)
                      })
              
              # å¦‚æœå·²ç»æ”¶é›†å¤Ÿ20ä¸ªï¼Œå°±åœæ­¢
              if len(tv_items) >= 20:
                  break

          # æŒ‰äººæ°”æ’åºï¼Œå–å‰20ä¸ª
          tv_items.sort(key=lambda x: x["popularity"], reverse=True)
          today_tv = tv_items[:20]

          # è·å–çƒ­é—¨ç”µå½±
          movie_items = []
          for page in range(1, 4):  # è·å–å‰3é¡µ
              movie_response = requests.get(
                  f"{BASE_URL}/trending/movie/day",
                  params={"api_key": API_KEY, "language": "zh-CN", "page": page}
              ).json()
              
              for item in movie_response.get("results", []):
                  # è¿‡æ»¤æ¡ä»¶ï¼šå¿…é¡»æœ‰æµ·æŠ¥ã€ç±»å‹ï¼Œä¸”æ˜¯è¿‘2å¹´å†…å®¹
                  if (item.get("poster_path") and 
                      item.get("genre_ids") and 
                      is_recent(item.get("release_date", ""), years=2)):
                      
                      movie_items.append({
                          "id": item.get("idâ€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
