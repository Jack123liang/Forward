name: Update TMDB Data Daily

on:
  schedule:
    # 每天北京时间早上 8 点运行 (UTC 0点)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许你手动点击按钮运行

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and Process Data
        run: |
          python - <<EOF
          import requests
          import json
          import os

          # 创建保存目录
          os.makedirs('public/data', exist_ok=True)

          # 数据源（这是原作者最稳的一个源，我们把它“借”过来）
          urls = {
              "TMDB_Trending.json": "https://for-ward.vercel.app/data/TMDB_Trending.json",
              "TMDB_Movie.json": "https://for-ward.vercel.app/data/TMDB_Movie.json",
              "TMDB_TV.json": "https://for-ward.vercel.app/data/TMDB_TV.json"
          }

          for filename, url in urls.items():
              try:
                  resp = requests.get(url, timeout=10)
                  data = resp.json()
                  
                  # 核心修复逻辑：确保 results 里的每一项都有正确的 media_type
                  if "results" in data:
                      for item in data["results"]:
                          if "TMDB_Movie" in filename:
                              item["media_type"] = "movie"
                          elif "TMDB_TV" in filename:
                              item["media_type"] = "tv"
                          # Trending 保持原样，通常它自带 media_type
                  
                  # 写入文件
                  with open(f'public/data/{filename}', 'w', encoding='utf-8') as f:
                      json.dump(data, f, ensure_ascii=False, indent=2)
                  print(f"Successfully updated {filename}")
              except Exception as e:
                  print(f"Failed to update {filename}: {e}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add public/data/*.json
          git commit -m "Update TMDB data with media_type fix" || exit 0
          git push
