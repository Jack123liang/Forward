name: Update TMDB Data Daily

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Official TMDB Data
        run: |
          python - <<EOF
          import requests
          import json
          import os
          from datetime import datetime

          API_KEY = "6358fd374e1372bd48effd9e21521917"
          BASE_URL = "https://api.themoviedb.org/3"
          SAVE_PATH = "public/data"
          os.makedirs(SAVE_PATH, exist_ok=True)

          configs = [
              {"file": "TMDB_Trending.json", "url": f"{BASE_URL}/trending/all/week", "type": "movie"},
              {"file": "Trending.json", "url": f"{BASE_URL}/trending/all/week", "type": "movie"},
              {"file": "TMDB_Movie.json", "url": f"{BASE_URL}/movie/now_playing", "type": "movie"},
              {"file": "Movie.json", "url": f"{BASE_URL}/movie/now_playing", "type": "movie"},
              {"file": "TMDB_TV.json", "url": f"{BASE_URL}/tv/on_the_air", "type": "tv"},
              {"file": "TV.json", "url": f"{BASE_URL}/tv/on_the_air", "type": "tv"}
          ]

          for config in configs:
              try:
                  params = {"api_key": API_KEY, "language": "zh-CN", "page": 1}
                  resp = requests.get(config["url"], params=params)
                  data = resp.json()

                  if "results" in data:
                      cleaned_results = []
                      for item in data["results"]:
                          title = item.get("title") or item.get("name") or "未知"
                          date_str = item.get("release_date") or item.get("first_air_date") or "1900-01-01"
                          
                          # --- 强力过滤逻辑 ---
                          try:
                              # 只保留 2024 年以后的片子，防止老片刷屏
                              year = int(date_str.split("-")[0])
                              if year < 2024: 
                                  continue
                          except:
                              continue
                          
                          clean_item = {
                              "id": item.get("id"),
                              "title": title,
                              "name": title,
                              "poster_path": item.get("poster_path"),
                              "backdrop_path": item.get("backdrop_path"),
                              "release_date": date_str,
                              "media_type": config["type"],
                              "vote_average": item.get("vote_average", 0)
                          }
                          cleaned_results.append(clean_item)
                      
                      # 只取过滤后的前 10 条
                      data["results"] = cleaned_results[:10]
                      data.pop("total_pages", None)
                      data.pop("total_results", None)

                  with open(f"{SAVE_PATH}/{config['file']}", 'w', encoding='utf-8') as f:
                      json.dump(data, f, ensure_ascii=False, indent=2)
                  print(f"Successfully updated {config['file']}")
              except Exception as e:
                  print(f"Error: {e}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add public/data/*.json
          git commit -m "Force filter old movies and update" || exit 0
          git push
