name: Update TMDB Data Daily

on:
  schedule:
    - cron: '0 0 * * *' # 每天早上 8 点运行
  workflow_dispatch: # 支持手动运行

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Official TMDB Data
        run: |
          python - <<EOF
          import requests
          import json
          import os

          API_KEY = "6358fd374e1372bd48effd9e21521917"
          BASE_URL = "https://api.themoviedb.org/3"
          SAVE_PATH = "public/data"
          os.makedirs(SAVE_PATH, exist_ok=True)

          configs = [
              {"file": "TMDB_Trending.json", "url": f"{BASE_URL}/trending/all/day", "type": None},
              {"file": "TMDB_Movie.json", "url": f"{BASE_URL}/movie/popular", "type": "movie"},
              {"file": "TMDB_TV.json", "url": f"{BASE_URL}/tv/popular", "type": "tv"}
          ]

          for config in configs:
              try:
                  params = {"api_key": API_KEY, "language": "zh-CN", "page": 1}
                  resp = requests.get(config["url"], params=params)
                  data = resp.json()

                  if "results" in data:
                      for item in data["results"]:
                          # --- 核心兼容性修复开始 ---
                          
                          # 1. 统一标题字段：确保无论电影还是剧集，都有 title
                          if "title" not in item or not item["title"]:
                              item["title"] = item.get("name")
                          
                          # 2. 统一日期字段：确保无论电影还是剧集，都有 release_date
                          if "release_date" not in item or not item["release_date"]:
                              item["release_date"] = item.get("first_air_date")
                          
                          # 3. 补全 media_type
                          if config["type"] == "movie":
                              item["media_type"] = "movie"
                          elif config["type"] == "tv":
                              item["media_type"] = "tv"
                          elif "media_type" not in item:
                              # Trending 接口如果没返回，根据是否有 name 猜一个
                              item["media_type"] = "tv" if "name" in item else "movie"
                          
                          # --- 核心兼容性修复结束 ---

                  with open(f"{SAVE_PATH}/{config['file']}", 'w', encoding='utf-8') as f:
                      json.dump(data, f, ensure_ascii=False, indent=2)
                  print(f"Successfully updated {config['file']}")
              except Exception as e:
                  print(f"Error updating {config['file']}: {e}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add public/data/*.json
          git commit -m "Update TMDB data with compatibility fix" || exit 0
          git push
