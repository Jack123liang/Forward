name: Update TMDB Data Daily

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and Transform TMDB Data
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          python - <<EOF
          import requests
          import json
          import os

          API_KEY = os.environ.get("TMDB_API_KEY")  # 从环境变量读取
          BASE_URL = "https://api.themoviedb.org/3"

          def fetch_genres():
              """获取类型映射"""
              movie_genres = requests.get(
                  f"{BASE_URL}/genre/movie/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              tv_genres = requests.get(
                  f"{BASE_URL}/genre/tv/list",
                  params={"api_key": API_KEY, "language": "zh-CN"}
              ).json().get("genres", [])
              
              return {g["id"]: g["name"] for g in movie_genres + tv_genres}

          def get_genre_title(genre_ids, genre_map):
              """获取类型标题（前3个）"""
              if not genre_ids:
                  return ""
              return "•".join([genre_map.get(gid, "") for gid in genre_ids[:3] if gid in genre_map])

          def is_recent(date_str, years=2):
              """判断是否为近期内容（默认2年内）"""
              if not date_str:
                  return False
              try:
                  release_date = datetime.strptime(date_str, "%Y-%m-%d")
                  cutoff_date = datetime.now() - timedelta(days=365 * years)
                  return release_date >= cutoff_date
              except:
                  return False

          # 获取类型映射
          genre_map = fetch_genres()

          # 获取热门电视剧（多页以确保有足够新内容）
          tv_items = []
          for page in range(1, 4):  # 获取前3页
              tv_response = requests.get(
                  f"{BASE_URL}/trending/tv/day",
                  params={"api_key": API_KEY, "language": "zh-CN", "page": page}
              ).json()
              
              for item in tv_response.get("results", []):
                  # 过滤条件：必须有海报、类型，且是近2年内容
                  if (item.get("poster_path") and 
                      item.get("genre_ids") and 
                      is_recent(item.get("first_air_date", ""), years=2)):
                      
                      tv_items.append({
                          "id": item.get("id"),
                          "type": "tv",
                          "title": item.get("name", ""),
                          "genreTitle": get_genre_title(item.get("genre_ids", []), genre_map),
                          "rating": item.get("vote_average", 0),
                          "overview": item.get("overview", ""),
                          "release_date": item.get("first_air_date", ""),
                          "poster_url": item.get("poster_path", ""),
                          "title_backdrop": item.get("backdrop_path", ""),
                          "genre_ids": item.get("genre_ids", []),
                          "popularity": item.get("popularity", 0)
                      })
              
              # 如果已经收集够20个，就停止
              if len(tv_items) >= 20:
                  break

          # 按人气排序，取前20个
          tv_items.sort(key=lambda x: x["popularity"], reverse=True)
          today_tv = tv_items[:20]

          # 获取热门电影
          movie_items = []
          for page in range(1, 4):  # 获取前3页
              movie_response = requests.get(
                  f"{BASE_URL}/trending/movie/day",
                  params={"api_key": API_KEY, "language": "zh-CN", "page": page}
              ).json()
              
              for item in movie_response.get("results", []):
                  # 过滤条件：必须有海报、类型，且是近2年内容
                  if (item.get("poster_path") and 
                      item.get("genre_ids") and 
                      is_recent(item.get("release_date", ""), years=2)):
                      
                      movie_items.append({
                          "id": item.get("id"),
                          "type": "movie",
                          "title": item.get("title", ""),
                          "genreTitle": get_genre_title(item.get("genre_ids", []), genre_map),
                          "rating": item.get("vote_average", 0),
                          "overview": item.get("overview", ""),
                          "release_date": item.get("release_date", ""),
                          "poster_url": item.get("poster_path", ""),
                          "title_backdrop": item.get("backdrop_path", ""),
                          "genre_ids": item.get("genre_ids", []),
                          "popularity": item.get("popularity", 0)
                      })
              
              if len(movie_items) >= 20:
                  break

          # 按人气排序，取前20个
          movie_items.sort(key=lambda x: x["popularity"], reverse=True)
          today_movies = movie_items[:20]

          # 保存为代码期望的格式
          output_data = {
              "today_tv": today_tv,
              "today_movies": today_movies
          }

          with open(f"{SAVE_PATH}/TMDB_Trending.json", 'w', encoding='utf-8') as f:
              json.dump(output_data, f, ensure_ascii=False, indent=2)
          
          print(f"Successfully updated TMDB_Trending.json")
          print(f"TV shows: {len(today_tv)}, Movies: {len(today_movies)}")
          
          # 输出最旧的内容日期供参考
          if today_tv:
              oldest_tv = min(today_tv, key=lambda x: x["release_date"])
              print(f"Oldest TV show: {oldest_tv['title']} ({oldest_tv['release_date']})")
          if today_movies:
              oldest_movie = min(today_movies, key=lambda x: x["release_date"])
              print(f"Oldest movie: {oldest_movie['title']} ({oldest_movie['release_date']})")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add public/data/*.json
          git commit -m "Update TMDB trending data (recent 2 years only)" || exit 0
          git push
